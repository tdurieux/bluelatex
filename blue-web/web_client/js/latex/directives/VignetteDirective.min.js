angular.module('bluelatex.Latex.Directives.Vignette',[]).directive('blVignette',['$document','$window',function(t,u){return{require:'blVignette',scope:{page:"@",scale:"=scale",type:"=type",url:"=url",synctex:"=synctex",current:"=current"},controller:function(n){var o=null;var q;var r;var s;n.hightlights=[{height:"10px",width:"200px",left:"150px",bottom:"25px"}];n.$watch("currentLine",function(a){n.hightlights=[];if(!s)return;if(!n.synctex)return;if(!n.synctex.blockNumberLine)return;if(!n.synctex.blockNumberLine[a])return;var b=n.synctex.blockNumberLine[a];if(!isArray(b)||!b[0])return;var c=[];var d={positionFirst:0,minLeft:0,maxLeft:0,bottom:b[0].bottom,height:b[0].height};for(var i=b.length-1;i>=1;i--){var e=b[i];if(e.page!=n.page)continue;if(e.type!='x')continue;if(e.bottom!=d.bottom){c.push(d);var d={positionFirst:i,minLeft:i,maxLeft:i,bottom:b[i].bottom,height:b[i].height};continue}if(e.left<b[d.minLeft].left){d.minLeft=i;d.positionFirst=i-d.positionFirst}else if(e.left>b[d.maxLeft].left){d.maxLeft=i}if(e.height>d.height){d.height=e.height}}c.push(d);for(var i=c.length-1;i>=0;i--){var a=c[i];var f=b[a.minLeft].parent.elements.indexOf(b[a.minLeft]);var g=b[a.minLeft].parent.elements.indexOf(b[a.maxLeft]);var h=b[a.minLeft].parent.elements.length-1;var j=b[a.minLeft].left;if(f<=1){j=b[a.minLeft].parent.left}else if(b[a.minLeft-1]){j=b[a.minLeft-1].left}var k=b[a.maxLeft].left-j;if(g<h&&b[a.maxLeft-1]){k=b[a.maxLeft-1].left-j}var l=convertToViewportPoint(j,a.bottom,s);var m=convertToViewportPoint(k,a.height,s);n.hightlights.push({height:(s.height-m[1])+"px",width:m[0]+"px",left:l[0]+"px",bottom:l[1]+"px"})}});function loadPdf(a){PDFJS.getDocument(a).then(renderPdf)}function loadImage(a){}function renderPdf(p){o=p;o.getPage(1).then(renderPage)}function renderPage(d){var e=q[0];var f=Number(n.scale);console.log(q.width,e.clientWidth);if(!f)f=e.clientWidth/d.getViewport(1.0).width;var g=e.getElementsByClassName('textLayer')[0];var h=e.getElementsByTagName('canvas')[0];var i=e.getElementsByTagName('hightlights')[0];var j=d.getViewport(f);s={scale:f,height:j.height};var k=h.getContext("2d");h.height=j.height;h.width=j.width;e.style.height=j.height+'px';g.innerHTML='';var l=getOutputScale(k);if(l.scaled){var m='scale('+(1/l.sx)+', '+(1/l.sy)+')';CustomStyle.setProp('transform',h,m);CustomStyle.setProp('transformOrigin',h,'0% 0%');if(g){CustomStyle.setProp('transform',g,m);CustomStyle.setProp('transformOrigin',g,'0% 0%')}if(i){CustomStyle.setProp('transform',i,m);CustomStyle.setProp('transformOrigin',i,'0% 0%')}}k._scaleX=l.sx;k._scaleY=l.sy;if(l.scaled){k.scale(l.sx,l.sy)}d.getTextContent().then(function(a){var b=new TextLayerBuilder({textLayerDiv:g,pageIndex:0});b.setTextContent(a);var c={canvasContext:k,viewport:j,textLayer:b};d.render(c)})}n.resize=function(e){q=e;if(o)o.getPage(1).then(renderPage)};n.loadPDF=function(e){q=e;loadPdf(n.url+'_'+n.page)}},link:function(b,c,d,e){var f=1;var g=d.page;var h=d.scale;var i=null;b.$watch("scale",function(a){if(!a)return;clearTimeout(i);i=setTimeout(function(){b.resize(c)},500)});d.$observe('scale',function(a){if(!a)return;clearTimeout(i);i=setTimeout(function(){b.resize(c)},500)});d.$observe("line",function(a){b.currentLine=a;console.log('line',a)});c.on('mousemove',function(a){a.preventDefault()});var j=null;u.onresize=function(){console.log("resize");clearTimeout(j);j=setTimeout(function(){b.resize(c)},500)};b.loadPDF(c)},template:'<canvas></canvas><div class="textLayer"></div><div class="hightlights"><div class="hightlight_line" ng-repeat="hightlight in hightlights" style="height:{{hightlight.height}};width:{{hightlight.width}};left:{{hightlight.left}};bottom:{{hightlight.bottom}}"></div></div>'}}]).directive('blVignette2',['$document','$window',function(m,n){return function(d,e,f){var g=1;var h=1;var j=f.page;var k=null;var l=f.scale;f.$observe('scale',function(a){l=a});if(f.type=='pdf'){d.$watch('block',function(a){for(var i=e[0].getElementsByClassName('cursor').length-1;i>=0;i--){e[0].removeChild(e[0].getElementsByClassName('cursor')[i])}if(a!=null){if(a[0].page==j){var x=a[0].block.xPosition*h;var y=a[0].block.yPosition*h;var b=m[0].createElement("div");b.style.position='absolute';b.classList.add("cursor");b.style.top=(a[0].block.yPosition/65536)*h+"pt";b.style.left=(a[0].block.xPosition/65536)*h+"pt";b.style.width="12px";b.style.height="12px";b.style.background='red';e[0].appendChild(b);return}}});e[0].onmousemove=function(a){if(d.synctex==null)return;var x=a.x-findPosX(e[0]);var y=a.y-findPosY(e[0]);for(var i=d.synctex.hBlocks.length-1;i>=0;i--){var b=d.synctex.hBlocks[i];if(j==b.page&&y<=viewport.height-b.bottom+g&&y>=viewport.height-b.bottom-b.height-g&&x>=b.left-g&&x<=b.left+b.width+g){for(var i=b.elements.length-1;i>=1;i--){var c=b.elements[i];if(c.left>=x&&b.elements[i-1].left<=x){d.currentElem=(i!=(b.elements.length-3)?b.elements[i+1]:c);d.$apply();return}}if(b.elements[1]){d.currentElem=b.elements[1];d.$apply();return}break}}d.currentElem={};d.$apply()};loadPdf(f.url+'_'+j)}}}]);