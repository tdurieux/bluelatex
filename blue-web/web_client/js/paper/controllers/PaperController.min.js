var createBlock=function(b,a){var c=preview.getElementsByClassName('preview_page_container');var d=document.createElement('div');var e=c[a-1].getElementsByTagName('img')[0];var f={scale:e.height/e.naturalHeight,height:e.height};console.log(f,e.width,e.naturalWidth);var g=convertToViewportPoint(b.left,b.bottom,f);var h=convertToViewportPoint(b.width,b.height,f);d.style.top=f.height-g[1]-(f.height-h[1])+'px';d.style.left=g[0]+'px';d.style.width=h[0]+'px';d.style.height=(f.height-h[1])+'px';d.classList.add(b.type);d.classList.add('debug_block');var i=document.createElement('div');i.classList.add('info');i.innerHTML='<span class="file">'+b.fileNumber+'</span><span class="line">'+b.line+'</span>';d.appendChild(i);c[a-1].appendChild(d)};var createElem=function(a,b){var c=preview.getElementsByClassName('preview_page_container');var d=document.createElement('div');var e=c[b-1].getElementsByTagName('img')[0];var f={scale:e.height/e.naturalHeight,height:e.height};var g=convertToViewportPoint(a.left,a.bottom,f);var h=convertToViewportPoint(a.width,a.height,f);d.style.top=f.height-g[1]-(f.height-h[1])+'px';d.style.left=g[0]+'px';d.style.width='1px';d.style.height=(f.height-h[1])+'px';d.classList.add('debug_block');d.classList.add(a.type);var i=document.createElement('div');i.classList.add('info');i.innerHTML='<span class="file">'+a.fileNumber+'</span><span class="line">'+a.line+'</span>';d.appendChild(i);c[b-1].appendChild(d)};var removeBlocks=function(){var a=preview.getElementsByClassName('debug_block');for(var i=a.length-1;i>=0;i--){var b=a[i];b.parentNode.removeChild(b)}};var displayBlocks=function(a,b){if(!isArray(a))return;for(var j=a.length-1;j>=0;j--){var c=a[j];createBlock(c,b);displayBlocks(c.blocks,b);for(var i=c.elements.length-1;i>=0;i--){var d=c.elements[i];createElem(d,b)}}};var displayPages=function(a){removeBlocks();for(var i in a){var b=a[i];displayBlocks(b.blocks,i)}};angular.module('bluelatex.Paper.Controllers.Paper',['angularFileUpload','bluelatex.Paper.Directives.Toc','bluelatex.Paper.Services.Ace','bluelatex.Paper.Services.Paper','bluelatex.Paper.Services.Ace','bluelatex.Latex.Services.SyncTexParser']).controller('PaperController',['$rootScope','$scope','localize','$location','AceService','PaperService','$routeParams','$upload','$log','MessagesService','SyncTexParserService',function(f,g,h,j,k,l,m,o,p,q,r){var s=m.id;g.pageViewport={};g.currentElem={};g.resources=[];g.paper={};g.listType='debug';g.mode='ace';g.logs=[];g.toc=[];g.content='';g.new_file={};g.synctex=null;g.current={line:0};g.zipURL=l.getZipUrl(s);g.pdfURL=l.getPDFUrl(s);g.vignetteType="image";g.urlPaper=l.getPaperUrlRoot(s);g.scale="auto";g.currentPage=1;g.totalPage=0;g.revision=Math.random();var t=function(){l.getSynctex(s).then(function(a){g.synctex=r.parse(a);g.totalPage=g.synctex.numberPages;g.$apply(function(){g.synctex=g.synctex})})};var u=function(){l.getLog(s).then(function(a){var b=LatexParser.parse(a,{});var c=[];for(var i=0;i<b.all.length;i++){var d=b.all[i];c.push({row:d.line-1,column:1,text:d.message,type:(d.level=="error")?"error":'warning'})}console.log(c);k.getSession().setAnnotations(c)})};var v=function(){l.getSynchronized(s).then(function(a){g.synchronizedFiles=a;w()},function(a){q.clear();switch(err.status){case 400:q.error('_Delete_resource_Some_parameters_are_missing_',err);break;case 401:q.error('_Delete_resource_Wrong_username_and_or_password_',err);break;case 500:q.error('_Delete_resource_Something_wrong_happened_',err);break;default:q.error('_Delete_resource_Something_wrong_happened_',err)}})};var w=function(){var b=l.getResourceUrl(s,s+".tex");l.downloadRessource(b).then(function(a){g.content=a;u()},function(a){})};var x=function(){var b=l.getResourceUrl(s+".tex");l.uploadResource(s,s+".tex",g.content).then(function(a){},function(a){})};var y=function(){l.getResources(s).then(function(a){g.resources=a},function(a){q.clear();switch(err.status){case 400:q.error('_Delete_resource_Some_parameters_are_missing_',err);break;case 401:q.error('_Delete_resource_Wrong_username_and_or_password_',err);break;case 500:q.error('_Delete_resource_Something_wrong_happened_',err);break;default:q.error('_Delete_resource_Something_wrong_happened_',err)}})};g.$on('$routeChangeSuccess',function(b,c){if(g.paper.authors.indexOf(f.loggedUser.name)>=0){clearInterval(z);l.leavePaper(s).then(function(a){})}});var z=0;var A=function(){l.getInfo(s).then(function(b){g.paper=b;g.paper.etag=b.header.etag;if(g.paper.authors.indexOf(f.loggedUser.name)>=0){z=setInterval(x,30000);l.joinPaper(s).then(function(a){});v();y();t()}},function(a){q.clear();switch(err.status){case 400:q.error('_Delete_resource_Some_parameters_are_missing_',err);break;case 401:q.error('_Delete_resource_Wrong_username_and_or_password_',err);break;case 500:q.error('_Delete_resource_Something_wrong_happened_',err);break;default:q.error('_Delete_resource_Something_wrong_happened_',err)}})};A();g.$watch('displaySyncTexBox',function(a){if(a)displayPages(g.synctex.pages);else removeBlocks()});g.$on('handleAction',function(a,b){if(g[b]){g[b]()}});g.switch_editor_mode=function(){g.mode=(g.mode=='ace'?'text':'ace');if(g.mode=='ace'){k.setContent(g.content);k.getEditor().focus()}};g.compile=function(){l.subscribePaperCompiler(s).then(function(a){console.log(a);u();t();g.revision++},function(a){u();t();g.revision++})};g.nextPage=function(){g.changePage(g.currentPage+1)};g.prevPage=function(){g.changePage(g.currentPage-1)};g.changePage=function(a){if(a>0&&a<=g.totalPage){g.currentPage=a;for(var i in g.synctex.blockNumberLine){if(g.synctex.blockNumberLine[i][0].page==a){g.goToLine(i);return}}}};g.goToLine=function(a){k.goToLine(a);g.current.line=a};g.aceLoaded=function(a){k.aceLoaded(a,function(){g.toc=k.getToc();k.getSession().on("change",function(){g.toc=k.getToc()});a.selection.on("changeCursor",function(){g.$apply(function(){g.current.line=a.selection.getCursor().row+1;if(!g.synctex)return;if(!g.synctex.blockNumberLine[g.current.line])return;g.currentPage=g.synctex.blockNumberLine[g.current.line][0].page})});a.focus()})};g.aceChanged=function(e){};g.onFileSelect=function(a){if(a.length>0){var b=a[0];g.new_file={title:b.name,name:b.name.replace(/\.[^\.]+$/,''),type:getFileType(b.name),file:b,extension:getFileNameExtension(b.name)}}};g.uploadResource=function(){l.uploadResource(s,g.new_file.title,g.new_file.file).then(function(a){if(a.response==true){y();g.new_file={}}else q.error('_Upload_resource_Some_parameters_are_missing_')},function(a){q.clear();switch(a.status){case 400:q.error('_Upload_resource_Some_parameters_are_missing_',a);break;case 401:q.error('_Upload_resource_Wrong_username_and_or_password_',a);break;case 500:q.error('_Upload_resource_Something_wrong_happened_',a);break;default:q.error('_Upload_resource_Something_wrong_happened_',a)}},function(a){p.debug(a)})};g.cancelUploadResource=function(){g.new_file={}};g.viewResource=function(a){};g.removeResource=function(b){l.removeResource(s,b.title).then(function(a){if(a.response==true){y();g.new_file={}}else q.error('_Delete_resource_Some_parameters_are_missing_')},function(a){q.clear();switch(a.status){case 400:q.error('_Delete_resource_Some_parameters_are_missing_',a);break;case 401:q.error('_Delete_resource_Wrong_username_and_or_password_',a);break;case 500:q.error('_Delete_resource_Something_wrong_happened_',a);break;default:q.error('_Delete_resource_Something_wrong_happened_',a)}})};g.downloadResource=function(a){window.open(l.getResourceUrl(s,a.title))};g.range=function(n){return new Array(parseInt(n))}}]);