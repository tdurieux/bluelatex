angular.module('bluelatex.Paper.Services.Ace',['ngStorage','ui.ace','bluelatex.Shared.Services.Configuration']).factory("AceService",['$localStorage','$log','apiRootUrl',function(r,s,t){var u;var v;var w;var z;var A={fontSize:'12px',readOnly:false,useWrapMode:true,showGutter:true,theme:'ace/theme/textmate',mode:'ace/mode/latex',modeName:'latex',softWrap:'free',keyBinding:'ace',fullLineSelection:true,highlightActiveLine:true,showInvisibles:false,showIndentGuides:true,showPrintMargin:true,useSoftTab:true,highlightSelectedWord:true,enableBehaviours:false,fadeFoldWidgets:false,incrementalSearch:false};if(r.aceSettings==null){r.aceSettings=A}else{A=r.aceSettings}var B=function(){r.aceSettings=A;w.setTheme(A.theme);w.setFontSize(A.fontSize);w.setReadOnly(A.readOnly);w.setKeyboardHandler(A.keyBinding);w.setSelectionStyle(A.fullLineSelection?'line':'text');w.setHighlightActiveLine(A.highlightActiveLine);w.setShowInvisibles(A.showInvisibles);w.setDisplayIndentGuides(A.showIndentGuides);w.renderer.setShowPrintMargin(A.showPrintMargin);w.setHighlightSelectedWord(A.highlightSelectedWord);w.session.setUseSoftTabs(A.useSoftTab);w.setBehavioursEnabled(A.enableBehaviours);w.setFadeFoldWidgets(A.fadeFoldWidgets);w.session.setMode(A.mode);w.session.modeName=A.modeName;z.setShowGutter(A.showGutter);switch(A.softWrap){case"off":v.setUseWrapMode(false);z.setPrintMarginColumn(80);break;case"free":v.setUseWrapMode(true);v.setWrapLimitRange(null,null);z.setPrintMarginColumn(80);break;default:v.setUseWrapMode(true);var a=parseInt(A.softWrap,10);v.setWrapLimitRange(a,a);z.setPrintMarginColumn(a)}};var C=function(a){w.gotoLine(a);w.focus()};var D=function(a,b){w=a;v=w.getSession();z=w.renderer;u=v.getValue();v.setUndoManager(new ace.UndoManager());w.on("changeSession",function(){v=w.getSession()});v.on("change",function(){u=v.getValue()});B();b(w)};var E=function(){var a=[];var b=['chapter','section','subsection','subsubsection','paragraph'];var c='\\\\('+b.join('|')+')(\\*)?{([^}]+)}';var d=new RegExp(c,"gi");var e=u.split('\n');for(var i=0;i<e.length;i++){var f=i+1;var g=e[i];var h;while((h=d.exec(g))!==null){var j=(h[1]);a.push({type:j,level:b.indexOf(j),restart:h[2]=='*',title:h[3],line:f})}}return a};var F=function(){mobwrite.shareAceObj=function(a){mobwrite.debug=true;mobwrite.shareObj.apply(this,[a.file]);mobwrite.syncGateway=t+"/papers/"+a.paper_id+"/q";this.file=a.file;this.element=a.file};mobwrite.shareAceObj.prototype=new mobwrite.shareObj('');mobwrite.shareAceObj.prototype.getClientText=function(){return mobwrite.shareAceObj.normalizeLinebreaks_(u)};mobwrite.shareAceObj.prototype.setClientText=function(a){v.setValue(a)};mobwrite.shareAceObj.prototype.patchClientText=function(a){this.dmp.Match_Distance=1000;this.dmp.Match_Threshold=0.6;var b=this.getClientText();var c=this.captureCursor_();var d=[];if(c){d[0]=c.startOffset;if('endOffset'in c){d[1]=c.endOffset}}var e=this.patch_apply_(a,b,d);if(b!=e){this.setClientText(e);if(c){c.startOffset=d[0];if(d.length>1){c.endOffset=d[1];if(c.startOffset>=c.endOffset){c.collapsed=true}}this.restoreCursor_(c)}}};mobwrite.shareAceObj.prototype.patch_apply_=function(a,b,c){if(a.length==0){return b}a=this.dmp.patch_deepCopy(a);var d=this.dmp.patch_addPadding(a);b=d+b+d;this.dmp.patch_splitMax(a);var e=0;for(var x=0;x<a.length;x++){var f=a[x].start2+e;var g=this.dmp.diff_text1(a[x].diffs);var h;var j=-1;if(g.length>this.dmp.Match_MaxBits){h=this.dmp.match_main(b,g.substring(0,this.dmp.Match_MaxBits),f);if(h!=-1){j=this.dmp.match_main(b,g.substring(g.length-this.dmp.Match_MaxBits),f+g.length-this.dmp.Match_MaxBits);if(j==-1||h>=j){h=-1}}}else{h=this.dmp.match_main(b,g,f)}if(h==-1){if(mobwrite.debug){window.console.warn('Patch failed: '+a[x])}e-=a[x].length2-a[x].length1}else{if(mobwrite.debug){window.console.info('Patch OK.')}e=h-f;var k;if(j==-1){k=b.substring(h,h+g.length)}else{k=b.substring(h,j+this.dmp.Match_MaxBits)}var l=this.dmp.diff_main(g,k,false);if(g.length>this.dmp.Match_MaxBits&&this.dmp.diff_levenshtein(l)/g.length>this.dmp.Patch_DeleteThreshold){if(mobwrite.debug){window.console.warn('Patch contents mismatch: '+a[x])}}else{var m=0;var n;for(var y=0;y<a[x].diffs.length;y++){var o=a[x].diffs[y];if(o[0]!==DIFF_EQUAL){n=this.dmp.diff_xIndex(l,m)}if(o[0]===DIFF_INSERT){b=b.substring(0,h+n)+o[1]+b.substring(h+n);for(var i=0;i<c.length;i++){if(c[i]+d.length>h+n){c[i]+=o[1].length}}}else if(o[0]===DIFF_DELETE){var p=h+n;var q=h+this.dmp.diff_xIndex(l,m+o[1].length);b=b.substring(0,p)+b.substring(q);for(var i=0;i<c.length;i++){if(c[i]+d.length>p){if(c[i]+d.length<q){c[i]=p-d.length}else{c[i]-=q-p}}}}if(o[0]!==DIFF_DELETE){m+=o[1].length}}}}}b=b.substring(d.length,b.length-d.length);return b};mobwrite.shareAceObj.prototype.captureCursor_=function(){var a=this.dmp.Match_MaxBits/2;var b=u;var c={};c.range=w.selection.getRange();c.cursor=w.selection.getCursor();var d=u.split('\n');var e=c.range.start.column;for(var i=0;i<c.range.start.row;i++){e+=d[i].length}selectionStart=e;e=c.range.end.column;for(var i=0;i<c.range.end.row;i++){e+=d[i].length}selectionEnd=e;c.scrollTop=w.session.getScrollTop();c.scrollLeft=w.session.getScrollLeft();c.startPrefix=b.substring(selectionStart-a,selectionStart);c.startSuffix=b.substring(selectionStart,selectionStart+a);c.startOffset=selectionStart;c.collapsed=(selectionStart==selectionEnd);if(!c.collapsed){c.endPrefix=b.substring(selectionEnd-a,selectionEnd);c.endSuffix=b.substring(selectionEnd,selectionEnd+a);c.endOffset=selectionEnd}return c};mobwrite.shareAceObj.prototype.restoreCursor_=function(a){this.dmp.Match_Distance=1000;this.dmp.Match_Threshold=0.9;var b=this.dmp.Match_MaxBits/2;var c=u;var d=a.startPrefix+a.startSuffix;var e,diff;var f=this.dmp.match_main(c,d,a.startOffset-b);if(f!==null){e=c.substring(f,f+d.length);diff=this.dmp.diff_main(d,e,false);f+=this.dmp.diff_xIndex(diff,a.startPrefix.length)}var g=null;if(!a.collapsed){d=a.endPrefix+a.endSuffix;g=this.dmp.match_main(c,d,a.endOffset-b);if(g!==null){e=c.substring(g,g+d.length);diff=this.dmp.diff_main(d,e,false);g+=this.dmp.diff_xIndex(diff,a.endPrefix.length)}}if(f===null&&g!==null){f=g}else if(f===null&&g===null){f=a.startOffset}if(g===null){g=f}var h=c.split('\n');var j=0;var k=0;var l=0;var m=false;var n=0;var o=0;for(var i=0;i<h.length;i++){if(j+h[i].length>f&&!m){k=i;l=f-j;m=true}if(j+h[i].length>g){n=i;o=g-j;break}j+=h[i].length}var p=ace.require('ace/range').Range;w.selection.setRange(new p(k,l,n,o));w.session.setScrollTop(a.scrollTop);w.session.setScrollLeft(a.scrollLeft)};mobwrite.shareAceObj.normalizeLinebreaks_=function(a){return a.replace(/\r\n/g,'\n').replace(/\r/g,'\n')};mobwrite.shareAceObj.shareHandler=function(a){return new mobwrite.shareAceObj(a)};mobwrite.shareHandlers.push(mobwrite.shareAceObj.shareHandler)};if(window.mobwrite!=null){F()}return{goToLine:C,getContent:function(){return u},setContent:function(c){return v.setValue(c)},getEditor:function(){return w},getSession:function(){return w.getSession()},loadSettings:B,aceLoaded:D,getToc:E,aceSettings:A}}]);