angular.module('bluelatex.Paper.Services.Ace',['ngStorage','ui.ace']).factory("AceService",['$localStorage','$log',function(k,l){var m;var n;var o;var p;var q={fontSize:'12px',readOnly:false,useWrapMode:true,showGutter:true,theme:'ace/theme/textmate',mode:'ace/mode/latex',modeName:'latex',softWrap:'free',keyBinding:'ace',fullLineSelection:true,highlightActiveLine:true,showInvisibles:false,showIndentGuides:true,showPrintMargin:true,useSoftTab:true,highlightSelectedWord:true,enableBehaviours:false,fadeFoldWidgets:false,incrementalSearch:false};if(k.aceSettings==null){k.aceSettings=q}else{q=k.aceSettings}var r=function(){k.aceSettings=q;o.setTheme(q.theme);o.setFontSize(q.fontSize);o.setReadOnly(q.readOnly);o.setKeyboardHandler(q.keyBinding);o.setSelectionStyle(q.fullLineSelection?'line':'text');o.setHighlightActiveLine(q.highlightActiveLine);o.setShowInvisibles(q.showInvisibles);o.setDisplayIndentGuides(q.showIndentGuides);o.renderer.setShowPrintMargin(q.showPrintMargin);o.setHighlightSelectedWord(q.highlightSelectedWord);o.session.setUseSoftTabs(q.useSoftTab);o.setBehavioursEnabled(q.enableBehaviours);o.setFadeFoldWidgets(q.fadeFoldWidgets);o.session.setMode(q.mode);o.session.modeName=q.modeName;p.setShowGutter(q.showGutter);switch(q.softWrap){case"off":n.setUseWrapMode(false);p.setPrintMarginColumn(80);break;case"free":n.setUseWrapMode(true);n.setWrapLimitRange(null,null);p.setPrintMarginColumn(80);break;default:n.setUseWrapMode(true);var a=parseInt(q.softWrap,10);n.setWrapLimitRange(a,a);p.setPrintMarginColumn(a)}};var s=function(a){o.gotoLine(a);o.focus()};var t=function(a,b){o=a;n=o.getSession();p=o.renderer;m=n.getValue();n.setUndoManager(new ace.UndoManager());o.on("changeSession",function(){n=o.getSession()});n.on("change",function(){m=n.getValue()});r();b(o)};var u=function(){var a=[];var b=['chapter','section','subsection','subsubsection','paragraph'];var c='\\\\('+b.join('|')+')(\\*)?{([^}]+)}';var d=new RegExp(c,"gi");var e=m.split('\n');for(var i=0;i<e.length;i++){var f=i+1;var g=e[i];var h;while((h=d.exec(g))!==null){var j=(h[1]);a.push({type:j,level:b.indexOf(j),restart:h[2]=='*',title:h[3],line:f})}}return a};return{goToLine:s,getContent:function(){return m},setContent:function(c){return n.setValue(c)},getEditor:function(){return o},getSession:function(){return o.getSession()},loadSettings:r,aceLoaded:t,getToc:u,aceSettings:q}}]);