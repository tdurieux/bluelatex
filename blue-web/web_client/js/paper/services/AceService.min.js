angular.module('bluelatex.Paper.Services.Ace',['ngStorage','ui.ace','bluelatex.Shared.Services.Configuration']).factory("AceService",['$localStorage','$log','apiRootUrl',function($localStorage,$log,apiRootUrl){var content;var _session;var _editor;var _renderer;var aceSettings={fontSize:'12px',readOnly:false,useWrapMode:true,showGutter:true,theme:'ace/theme/textmate',mode:'ace/mode/latex',modeName:'latex',softWrap:'free',keyBinding:'ace',fullLineSelection:true,highlightActiveLine:true,showInvisibles:false,showIndentGuides:true,showPrintMargin:true,useSoftTab:true,highlightSelectedWord:true,enableBehaviours:false,fadeFoldWidgets:false,incrementalSearch:false};if($localStorage.aceSettings==null){$localStorage.aceSettings=aceSettings}else{aceSettings=$localStorage.aceSettings}var loadSettings=function(){$localStorage.aceSettings=aceSettings;_editor.setTheme(aceSettings.theme);_editor.setFontSize(aceSettings.fontSize);_editor.setReadOnly(aceSettings.readOnly);_editor.setKeyboardHandler(aceSettings.keyBinding);_editor.setSelectionStyle(aceSettings.fullLineSelection?'line':'text');_editor.setHighlightActiveLine(aceSettings.highlightActiveLine);_editor.setShowInvisibles(aceSettings.showInvisibles);_editor.setDisplayIndentGuides(aceSettings.showIndentGuides);_editor.renderer.setShowPrintMargin(aceSettings.showPrintMargin);_editor.setHighlightSelectedWord(aceSettings.highlightSelectedWord);_editor.session.setUseSoftTabs(aceSettings.useSoftTab);_editor.setBehavioursEnabled(aceSettings.enableBehaviours);_editor.setFadeFoldWidgets(aceSettings.fadeFoldWidgets);_editor.session.setMode(aceSettings.mode);_editor.session.modeName=aceSettings.modeName;_renderer.setShowGutter(aceSettings.showGutter);switch(aceSettings.softWrap){case"off":_session.setUseWrapMode(false);_renderer.setPrintMarginColumn(80);break;case"free":_session.setUseWrapMode(true);_session.setWrapLimitRange(null,null);_renderer.setPrintMarginColumn(80);break;default:_session.setUseWrapMode(true);var col=parseInt(aceSettings.softWrap,10);_session.setWrapLimitRange(col,col);_renderer.setPrintMarginColumn(col)}};var goToLine=function(line){_editor.gotoLine(line);_editor.focus()};var aceLoaded=function(_e,callback){_editor=_e;_session=_editor.getSession();_renderer=_editor.renderer;content=_session.getValue();_session.setUndoManager(new ace.UndoManager());_editor.on("changeSession",function(){_session=_editor.getSession()});_session.on("change",function(){content=_session.getValue()});loadSettings();callback(_editor)};var getToc=function(){var toc=[];var keys=['chapter','section','subsection','subsubsection','paragraph'];var regex='\\\\('+keys.join('|')+')(\\*)?{([^}]+)}';var reg=new RegExp(regex,"gi");var astring=content.split('\n');for(var i=0;i<astring.length;i++){var number=i+1;var line=astring[i];var result;while((result=reg.exec(line))!==null){var type=(result[1]);toc.push({type:type,level:keys.indexOf(type),restart:result[2]=='*',title:result[3],line:number})}}return toc};var initMobWrite=function(){mobwrite.shareAceObj=function(paper){mobwrite.debug=true;mobwrite.shareObj.apply(this,[paper.file]);mobwrite.syncGateway=apiRootUrl+"/papers/"+paper.paper_id+"/q";this.file=paper.file;this.element=paper.file};mobwrite.shareAceObj.prototype=new mobwrite.shareObj('');mobwrite.shareAceObj.prototype.getClientText=function(){return mobwrite.shareAceObj.normalizeLinebreaks_(content)};mobwrite.shareAceObj.prototype.setClientText=function(text){_session.setValue(text)};mobwrite.shareAceObj.prototype.patchClientText=function(patches){this.dmp.Match_Distance=1000;this.dmp.Match_Threshold=0.6;var oldClientText=this.getClientText();var cursor=this.captureCursor_();var offsets=[];if(cursor){offsets[0]=cursor.startOffset;if('endOffset'in cursor){offsets[1]=cursor.endOffset}}var newClientText=this.patch_apply_(patches,oldClientText,offsets);if(oldClientText!=newClientText){this.setClientText(newClientText);if(cursor){cursor.startOffset=offsets[0];if(offsets.length>1){cursor.endOffset=offsets[1];if(cursor.startOffset>=cursor.endOffset){cursor.collapsed=true}}this.restoreCursor_(cursor)}}};mobwrite.shareAceObj.prototype.patch_apply_=function(patches,text,offsets){if(patches.length==0){return text}patches=this.dmp.patch_deepCopy(patches);var nullPadding=this.dmp.patch_addPadding(patches);text=nullPadding+text+nullPadding;this.dmp.patch_splitMax(patches);var delta=0;for(var x=0;x<patches.length;x++){var expected_loc=patches[x].start2+delta;var text1=this.dmp.diff_text1(patches[x].diffs);var start_loc;var end_loc=-1;if(text1.length>this.dmp.Match_MaxBits){start_loc=this.dmp.match_main(text,text1.substring(0,this.dmp.Match_MaxBits),expected_loc);if(start_loc!=-1){end_loc=this.dmp.match_main(text,text1.substring(text1.length-this.dmp.Match_MaxBits),expected_loc+text1.length-this.dmp.Match_MaxBits);if(end_loc==-1||start_loc>=end_loc){start_loc=-1}}}else{start_loc=this.dmp.match_main(text,text1,expected_loc)}if(start_loc==-1){if(mobwrite.debug){window.console.warn('Patch failed: '+patches[x])}delta-=patches[x].length2-patches[x].length1}else{if(mobwrite.debug){window.console.info('Patch OK.')}delta=start_loc-expected_loc;var text2;if(end_loc==-1){text2=text.substring(start_loc,start_loc+text1.length)}else{text2=text.substring(start_loc,end_loc+this.dmp.Match_MaxBits)}var diffs=this.dmp.diff_main(text1,text2,false);if(text1.length>this.dmp.Match_MaxBits&&this.dmp.diff_levenshtein(diffs)/text1.length>this.dmp.Patch_DeleteThreshold){if(mobwrite.debug){window.console.warn('Patch contents mismatch: '+patches[x])}}else{var index1=0;var index2;for(var y=0;y<patches[x].diffs.length;y++){var mod=patches[x].diffs[y];if(mod[0]!==DIFF_EQUAL){index2=this.dmp.diff_xIndex(diffs,index1)}if(mod[0]===DIFF_INSERT){text=text.substring(0,start_loc+index2)+mod[1]+text.substring(start_loc+index2);for(var i=0;i<offsets.length;i++){if(offsets[i]+nullPadding.length>start_loc+index2){offsets[i]+=mod[1].length}}}else if(mod[0]===DIFF_DELETE){var del_start=start_loc+index2;var del_end=start_loc+this.dmp.diff_xIndex(diffs,index1+mod[1].length);text=text.substring(0,del_start)+text.substring(del_end);for(var i=0;i<offsets.length;i++){if(offsets[i]+nullPadding.length>del_start){if(offsets[i]+nullPadding.length<del_end){offsets[i]=del_start-nullPadding.length}else{offsets[i]-=del_end-del_start}}}}if(mod[0]!==DIFF_DELETE){index1+=mod[1].length}}}}}text=text.substring(nullPadding.length,text.length-nullPadding.length);return text};mobwrite.shareAceObj.prototype.captureCursor_=function(){var padLength=this.dmp.Match_MaxBits/2;var text=content;var cursor={};cursor.range=_editor.selection.getRange();cursor.cursor=_editor.selection.getCursor();var splittedContent=content.split('\n');var count=cursor.range.start.column;for(var i=0;i<cursor.range.start.row;i++){count+=splittedContent[i].length}selectionStart=count;count=cursor.range.end.column;for(var i=0;i<cursor.range.end.row;i++){count+=splittedContent[i].length}selectionEnd=count;cursor.scrollTop=_editor.session.getScrollTop();cursor.scrollLeft=_editor.session.getScrollLeft();cursor.startPrefix=text.substring(selectionStart-padLength,selectionStart);cursor.startSuffix=text.substring(selectionStart,selectionStart+padLength);cursor.startOffset=selectionStart;cursor.collapsed=(selectionStart==selectionEnd);if(!cursor.collapsed){cursor.endPrefix=text.substring(selectionEnd-padLength,selectionEnd);cursor.endSuffix=text.substring(selectionEnd,selectionEnd+padLength);cursor.endOffset=selectionEnd}return cursor};mobwrite.shareAceObj.prototype.restoreCursor_=function(cursor){this.dmp.Match_Distance=1000;this.dmp.Match_Threshold=0.9;var padLength=this.dmp.Match_MaxBits/2;var newText=content;var pattern1=cursor.startPrefix+cursor.startSuffix;var pattern2,diff;var cursorStartPoint=this.dmp.match_main(newText,pattern1,cursor.startOffset-padLength);if(cursorStartPoint!==null){pattern2=newText.substring(cursorStartPoint,cursorStartPoint+pattern1.length);diff=this.dmp.diff_main(pattern1,pattern2,false);cursorStartPoint+=this.dmp.diff_xIndex(diff,cursor.startPrefix.length)}var cursorEndPoint=null;if(!cursor.collapsed){pattern1=cursor.endPrefix+cursor.endSuffix;cursorEndPoint=this.dmp.match_main(newText,pattern1,cursor.endOffset-padLength);if(cursorEndPoint!==null){pattern2=newText.substring(cursorEndPoint,cursorEndPoint+pattern1.length);diff=this.dmp.diff_main(pattern1,pattern2,false);cursorEndPoint+=this.dmp.diff_xIndex(diff,cursor.endPrefix.length)}}if(cursorStartPoint===null&&cursorEndPoint!==null){cursorStartPoint=cursorEndPoint}else if(cursorStartPoint===null&&cursorEndPoint===null){cursorStartPoint=cursor.startOffset}if(cursorEndPoint===null){cursorEndPoint=cursorStartPoint}var splittedText=newText.split('\n');var count=0;var startRow=0;var startCol=0;var startFound=false;var endRow=0;var endCol=0;for(var i=0;i<splittedText.length;i++){if(count+splittedText[i].length>cursorStartPoint&&!startFound){startRow=i;startCol=cursorStartPoint-count;startFound=true}if(count+splittedText[i].length>cursorEndPoint){endRow=i;endCol=cursorEndPoint-count;break}count+=splittedText[i].length}var Range=ace.require('ace/range').Range;_editor.selection.setRange(new Range(startRow,startCol,endRow,endCol));_editor.session.setScrollTop(cursor.scrollTop);_editor.session.setScrollLeft(cursor.scrollLeft)};mobwrite.shareAceObj.normalizeLinebreaks_=function(text){return text.replace(/\r\n/g,'\n').replace(/\r/g,'\n')};mobwrite.shareAceObj.shareHandler=function(node){return new mobwrite.shareAceObj(node)};mobwrite.shareHandlers.push(mobwrite.shareAceObj.shareHandler)};if(window.mobwrite!=null){initMobWrite()}return{goToLine:goToLine,getContent:function(){return content},setContent:function(c){return _session.setValue(c)},getEditor:function(){return _editor},getSession:function(){return _editor.getSession()},loadSettings:loadSettings,aceLoaded:aceLoaded,getToc:getToc,aceSettings:aceSettings,getCommands:function(){return ace.commands}}}]);