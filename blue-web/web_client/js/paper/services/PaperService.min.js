angular.module('bluelatex.Paper.Services.Paper',["ngResource",'jmdobry.angular-cache','bluelatex.Shared.Services.Configuration']).factory("PaperService",['$resource','$http','$upload','$q','$angularCacheFactory','$log','apiRootUrl',function(n,o,q,r,s,t,u){var v=s('paperCache',{maxAge:300000,storageMode:'localStorage',deleteOnExpire:'aggressive',verifyIntegrity:true});var w=n(u+"/papers/:paper_id",null,{"new":{method:"POST",headers:{'Content-Type':'application/x-www-form-urlencoded'},format:'json',isArray:false,transformResponse:[function(a,b){return{response:JSON.parse(a)}}].concat(o.defaults.transformResponse)},"delete":{method:"DELETE",transformResponse:[function(a,b){return{response:JSON.parse(a)}}].concat(o.defaults.transformResponse)}});var x=n(u+"/papers/:paper_id/info",null,{"edit":{method:"PATCH",headers:{'Content-Type':'application/json-patch'},transformRequest:[function(a,b){var c=b();c['If-Match']=a.etag;return a.path_json}].concat(o.defaults.transformRequest)},"get":{method:"GET",transformResponse:[function(a,b){a=JSON.parse(a);a.header=b();return a}].concat(o.defaults.transformResponse)}});var y=n(u+"/papers/:paper_id/files/synchronized",null,{"get":{method:"GET",format:'json',isArray:true}});var z=n(u+"/papers/:paper_id/files/resources/:resource",null,{"get":{method:"GET",isArray:true,transformResponse:[function(a,b){var c=[];a=JSON.parse(a);for(var i=0;i<a.length;i++){var d=a[i];c.push({title:d,name:d.replace(/\.[^\.]+$/,''),type:getFileType(d),extension:getFileNameExtension(d)})}return c}].concat(o.defaults.transformResponse)},"delete":{method:"DELETE",transformResponse:[function(a,b){return{response:JSON.parse(a)}}].concat(o.defaults.transformResponse)}});var A=n(u+"/users/:username/papers",{username:"@username"},{"get":{method:"GET",isArray:true,headers:{'Content-Type':'application/x-www-form-urlencoded'}}});var B=function(e,f,g){var h=r.defer();var i=h.promise;q.upload({url:u+'/papers/'+e+'/files/resources/'+g,method:'POST',file:f,}).progress(function(a){t.log('percent: '+parseInt(100.0*a.loaded/a.total));h.notify(parseInt(100.0*a.loaded/a.total))}).success(function(a,b,c,d){h.resolve({data:a,status:b,headers:c,config:d})}).error(function(a,b){h.reject({data:a,status:b})});return i};return{create:function(p){var b=r.defer();var c=b.promise;w.new({},jsonToPostParameters(p)).$promise.then(function(a){p.id=a.response;v.remove('/userPapers');v.put('/papers/'+p.id,p);b.resolve(p)},function(a){t.error(a);b.reject(a)},function(a){b.notify(a)});return c},delete:function(b){var c=r.defer();var d=c.promise;w.delete({paper_id:b}).$promise.then(function(a){v.remove('/userPapers');v.remove('/papers/'+b);c.resolve(a)},function(a){t.error(a);c.reject(a)},function(a){c.notify(a)});return d},getInfo:function(b){var c=r.defer();var d=c.promise;if(v.get('/papers/'+b))c.resolve(v.get('/papers/'+b));else{x.get({paper_id:b}).$promise.then(function(a){v.put('/papers/'+b,a);c.resolve(a)},function(a){t.error(a);c.reject(a)},function(a){c.notify(a)})}return d},modify:function(b,c){var d=[];if(b.title!=c.title){d.push({'op':'replace',"path":"/title","value":b.title})}var e=false;for(var i=0;i<b.authors.length;i++){var f=b.authors[i];if(c.authors.indexOf(f)<0){e=true;break}}for(var i=0;i<c.authors.length;i++){var f=c.authors[i];if(b.authors.indexOf(f)<0){e=true;break}}if(e){d.push({'op':'replace',"path":"/authors","value":b.authors})}var g=false;for(var i=0;i<b.reviewers.length;i++){var h=b.reviewers[i];if(c.reviewers.indexOf(h)<0){g=true;break}}for(var i=0;i<c.reviewers.length;i++){var h=c.reviewers[i];if(b.reviewers.indexOf(h)<0){g=true;break}}if(g){d.push({'op':'replace',"path":"/reviewers","value":b.reviewers})}var j=false;for(var i=0;i<b.tags.length;i++){var k=b.tags[i];if(c.tags.indexOf(k)<0){j=true;break}}for(var i=0;i<c.tags.length;i++){var k=c.tags[i];if(b.tags.indexOf(k)<0){j=true;break}}if(j){d.push({'op':'replace',"path":"/tags","value":b.tags})}if(b.branch!=c.branch){d.push({'op':'replace',"path":"/branch","value":b.branch})}if(b.cls!=c.cls){d.push({'op':'replace',"path":"/cls","value":b.cls})}var l=r.defer();var m=l.promise;x.edit({paper_id:b.id},{"etag":b.etag,path_json:d}).$promise.then(function(a){v.remove('/papers/'+b.id);l.resolve(a)},function(a){t.error(a);l.reject(a)},function(a){l.notify(a)});return m},getResources:function(b){var c=r.defer();var d=c.promise;if(v.get('/resources/'+b))c.resolve(v.get('/resources/'+b));else{z.get({paper_id:b}).$promise.then(function(a){v.put('/resources/'+b,a);c.resolve(a)},function(a){t.error(a);c.reject(a)},function(a){c.notify(a)})}return d},getResourceUrl:function(a,b){return u+'/papers/'+a+'/files/resources/'+b},uploadResource:function(a,b,c){return B(a,c,b)},removeResource:function(a,b){return z.delete({paper_id:a,resource:b}).$promise},getSynchronized:function(a){return y.get({paper_id:a}).$promise},getZipUrl:function(a){return u+"/papers/"+a+".zip"},getUserPapers:function(b){var c=r.defer();var d=c.promise;if(v.get('/userPapers'))c.resolve(v.get('/userPapers'));else{A.get({username:b.name}).$promise.then(function(a){v.put('/userPapers',a);c.resolve(a)},function(a){t.error(a);c.reject(a)},function(a){c.notify(a)})}return d}}}]);